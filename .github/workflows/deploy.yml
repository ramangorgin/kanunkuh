name: ðŸš€ Auto Deploy to Server

on:
  push:
    branches:
      - main  

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Connect and Deploy via SSH
        uses: appleboy/ssh-action@v0.1.10
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_KEY }}
          script: |
            set -e

            echo "ðŸ”¹ 1. Entering to the project directory"
            cd /var/www/kanunkuh  

            echo "ðŸ”¹ 2. Adding GitHub to known_hosts"
            mkdir -p ~/.ssh
            ssh-keyscan -t ed25519 github.com >> ~/.ssh/known_hosts

            echo "ðŸ”¹ 3. Pulling the latest version from GitHub"
            sudo git pull origin main

            echo "ðŸ”¹ 4. Setting file ownership for ubuntu"
            sudo chown -R ubuntu:www-data /var/www/kanunkuh
            sudo chmod -R 775 storage bootstrap/cache

            echo "ðŸ”¹ 5. Ensuring .env file exists and switching to production"
            if [ -f .env.production ]; then
              cp .env.production .env
            fi
            sudo sed -i 's/^APP_ENV=.*/APP_ENV=production/' .env

            echo "ðŸ”¹ 6. Installing composer dependencies"
            sudo composer install --no-interaction --prefer-dist --optimize-autoloader --no-dev

            echo "ðŸ”¹ 7. Running migrate and cache clear"
            sudo php artisan migrate --force
            sudo php artisan optimize
            sudo php artisan cache:clear
            sudo php artisan config:clear
            sudo php artisan view:clear

            echo "Deployment was successfulâœ…"
